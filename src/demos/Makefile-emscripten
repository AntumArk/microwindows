#
# Link Microwindows EMSCRIPTEN demos Makefile
#
# Run with src/link-emscripten script
# Run demos with ./emrun <appname>[.html]
#
# This will eventually be integrated into the demos/mwin and demos/nanox Makefiles
#
MICROWIN=Y
NANOX=Y
NX11=Y

MW_DIR_SRC = .
DEFINES += -DEMSCRIPTEN=1
DEFINES += -DHAVE_FREETYPE_2_SUPPORT=1	# for demo-aafont.c
INCLUDEDIRS += -Iinclude
CFLAGS += -O3

CFLAGS += -s USE_SDL=2 -s USE_ZLIB=1 -s USE_FREETYPE=1 -s USE_LIBPNG=1
CFLAGS += -s EMTERPRETIFY=1 -s EMTERPRETIFY_ASYNC=1  -s WASM=0
CFLAGS += -s TOTAL_MEMORY=67108864
CFLAGS += -s ERROR_ON_UNDEFINED_SYMBOLS=0

COMPILEARGS = $(CFLAGS) $(WARNINGS) $(INCLUDEDIRS) $(DEFINES) $(EXTRAFLAGS)

DEMOFONTS = --preload-file $(MW_DIR_SRC)/fonts/em-fonts@fonts/truetype 
NX11FONTS = --preload-file $(MW_DIR_SRC)/fonts/em-fonts@/usr/share/fonts/truetype

MWINLIBS = lib/libmwin.a
NANOXLIBS = lib/libnano-X.a
NX11LIBS = lib/libNX11.a $(NX11FONTS) $(NANOXLIBS)

CC = emcc

all:
ifdef MICROWIN
	$(CC) $(COMPILEARGS) -o bin/mwdemo2.html demos/mwin/mwdemo2.c $(MWINLIBS)
	$(CC) $(COMPILEARGS) -o bin/mwdemo.html demos/mwin/mwdemo.c $(MWINLIBS)
	$(CC) $(COMPILEARGS) -o bin/mwdemo2.html demos/mwin/mwdemo2.c $(MWINLIBS)
	$(CC) $(COMPILEARGS) -o bin/mwdvetest.html demos/mwin/mwdvetest.c $(MWINLIBS) $(DEMOFONTS) \
		--embed-file $(MW_DIR_SRC)/images/demos/mwin/mwdvetest/dveres.res@/this.res
	$(CC) $(COMPILEARGS) -o bin/mwlistcombo.html demos/mwin/mwlistcombo.c $(MWINLIBS) 
endif
ifdef NANOX
	$(CC) $(COMPILEARGS) -o bin/demo-ttfont.html demos/nanox/demo-ttfont.c $(NANOXLIBS) $(DEMOFONTS)
	$(CC) $(COMPILEARGS) -o bin/demo-aafont.html demos/nanox/demo-aafont.c $(NANOXLIBS) $(DEMOFONTS) \
		--embed-file $(MW_DIR_SRC)/images/demos/nanox/aademo.txt@bin/
	$(CC) $(COMPILEARGS) -o bin/demo-composite.html demos/nanox/demo-composite.c $(NANOXLIBS) $(DEMOFONTS) \
		--embed-file $(MW_DIR_SRC)/images/demos/nanox/alphademo.png@images/demos/nanox/
	$(CC) $(COMPILEARGS) -o bin/demo-agg.html demos/nanox/demo-agg.cpp demos/nanox/agglite.cpp $(NANOXLIBS)
	$(CC) $(COMPILEARGS) -o bin/demo-grabkey.html demos/nanox/demo-grabkey.c $(NANOXLIBS)
	$(CC) $(COMPILEARGS) -o bin/nxeyes.html demos/nanox/nxeyes.c $(NANOXLIBS)
#	$(CC) $(COMPILEARGS) -o bin/demo-arc.html demos/nanox/demo-arc.c $(NANOXLIBS)
#	$(CC) $(COMPILEARGS) -o bin/hello.html demos/nanox/hello.c $(NANOXLIBS)
endif
ifdef NX11
	$(CC) $(COMPILEARGS) -o bin/xgreen.html contrib/nx11-test/xgreen.c $(NX11LIBS)
	$(CC) $(COMPILEARGS) -o bin/draw.html contrib/nx11-test/draw.c $(NX11LIBS)
	$(CC) $(COMPILEARGS) -o bin/xhello.html contrib/nx11-test/xhello.c $(NX11LIBS)
#	$(CC) $(COMPILEARGS) -o bin/testarc.html contrib/nx11-test/testarc.c $(NX11LIBS)
#	$(CC) $(COMPILEARGS) -o bin/xmouse.html contrib/nx11-test/xmouse.c $(NX11LIBS)
#	$(CC) $(COMPILEARGS) -o bin/williams.html contrib/nx11-test/williams.c $(NX11LIBS)
endif
